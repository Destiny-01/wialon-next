import Head from 'next/head';
import Image from 'next/image';
import { Inter } from 'next/font/google';
import styles from '@/styles/Home.module.css';
import { useEffect, useState } from 'react';

const inter = Inter({ subsets: ['latin'] });
export async function getStaticProps() {
  var wialon = require('wialon');

  let resource, unit, unit_group;

  var opts = {
    // authz params
    authz: {
      token:
        'cff41ecd2f9615c24a95c8e9d906cde9DFC283DDD9407133F3B10D5E589A8419681732CF',
    },
  };

  var session = wialon(opts).session;
  var paramsResource = {
    spec: {
      itemsType: 'avl_resource',
      propType: 'propitemname',
      propName: 'reporttemplates',
      propValueMask: '*',
      sortType: 'sys_name',
    },
    force: 1,
    flags: 8193,
    from: 0,
    to: 0,
  };

  var paramsUnit = {
    spec: {
      itemsType: 'avl_unit',
      propType: 'propitemname',
      propName: 'reporttemplates',
      propValueMask: '*',
      sortType: 'sys_name',
    },
    force: 1,
    flags: 8193,
    from: 0,
    to: 0,
  };

  var paramsUnitGroup = {
    spec: {
      itemsType: 'avl_unit_group',
      propType: 'propitemname',
      propName: 'reporttemplates',
      propValueMask: '*',
      sortType: 'sys_name',
    },
    force: 1,
    flags: 8193,
    from: 0,
    to: 0,
  };

  await session
    .request('core/search_items', paramsResource)
    .then(async function (data) {
      console.log('======resource======', data);
      resource = data.items;
    })
    .catch(function (err) {
      console.log(err);
      return;
    });

  await session
    .request('core/search_items', paramsUnit)
    .then(async function (data) {
      console.log('======unit======', data);
      unit = data.items;
    })
    .catch(function (err) {
      console.log(err);
      return;
    });

  await session
    .request('core/search_items', paramsUnitGroup)
    .then(async function (data) {
      console.log('=========unit_group========', data);
      unit_group = data.items;
    })
    .catch(function (err) {
      console.log(err);
      return;
    });

  return {
    props: {
      resource,
      unit,
      unit_group,
    },
  };
}

export default function Home({ resource, unit, unit_group }) {
  const [resourceName, setResoureName] = useState('');
  const [pro_unit, setProUnit] = useState([]);

  // console.log('========resource========', resource);
  // console.log('========unit========', unit);
  console.log('========unit_group========', unit_group);
  console.log('========unit========', unit);
  const onOptionChangeHandler = (event) => {
    setResoureName(event.target.value);
    ///console.log('User Selected Value - ', event.target.value);
  };

  useEffect(() => {
    const filterUnitGroup = unit_group.filter((item) => {
      const unitGroup = item.nm.split(' ')[0].toLowerCase();
      const resourceGroup = resourceName.split(/[ | - | _]/)[0].toLowerCase();
      return unitGroup === resourceGroup;
    });
    const objectIds = filterUnitGroup[0]?.u;

    function filterObjectsByIds(unit, objectIds) {
      return unit.filter((obj) => objectIds?.includes(obj.id));
    }

    setProUnit(filterObjectsByIds(unit, objectIds));

    console.log('========pro_unit========', pro_unit);
    // console.log('========filterUnitGroup========', filterUnitGroup);
    console.log('=========resource=========', resource);
  }, [resourceName, unit_group]);
  console.log('========pro_unit outside========', pro_unit);
  // console.log('=========resourceName=========', resourceName);

  const resourceTemplate = resource.filter((item) => {
    return item.nm === resourceName;
  });

  const report = resourceTemplate && resourceTemplate[0]?.rep;

  console.log('=========resourceTemplate=========', report);
  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name='description' content='Generated by create next app' />
        <meta name='viewport' content='width=device-width, initial-scale=1' />
        <link rel='icon' href='/favicon.ico' />
      </Head>
      <main>
        <div className='my-5'>
          <h1 className='text-center p-2'>
            Wialon Playground - Execute custom report
          </h1>

          <div className='container-sm align-items-center'>
            <div className='row mb-4'>
              <div className='col-lg-6 col-md-6 col-sm-12 col-xxl-3'>
                <div className='card custom-card'>
                  <div className='card-header'>
                    <div className='card-title'>Select resource and table</div>
                  </div>
                  <div className='card-body'>
                    <select
                      id='res'
                      className='js-example-templating js-persons form-control'
                      onChange={onOptionChangeHandler}>
                      <option>Please choose one option</option>
                      {resource.map((item) => (
                        <option value={item.nm} key={item.id}>
                          {item.nm}
                        </option>
                      ))}
                    </select>
                  </div>
                </div>
              </div>
              <div className='col-lg-6 col-md-6 col-sm-12 col-xxl-3'>
                <div className='card custom-card'>
                  <div className='card-header'>
                    <div className='card-title'>Templates</div>
                  </div>
                  <div className='card-body'>
                    <select
                      id='templ'
                      className='js-example-templating js-persons form-control'>
                      {report &&
                        Object.keys(report).map((key) => (
                          <option value={report[key].n} key={report[key].id}>
                            {report[key].n}
                          </option>
                        ))}
                    </select>
                  </div>
                </div>
              </div>
              <div className='col-lg-6 col-md-6 col-sm-12 col-xxl-3'>
                <div className='card custom-card'>
                  <div className='card-header'>
                    <div className='card-title'>Select unit</div>
                  </div>
                  <div className='card-body'>
                    <select
                      id='units'
                      className='js-example-templating js-persons form-control'>
                      {pro_unit.map((item) => (
                        <option value={item.nm} key={item.id}>
                          {item.nm}
                        </option>
                      ))}
                    </select>
                  </div>
                </div>
              </div>
              <div className='col-lg-6 col-md-6 col-sm-12 col-xxl-3'>
                <div className='card custom-card'>
                  <div className='card-header'>
                    <div className='card-title'>Select time interval</div>
                  </div>
                  <div className='card-body'>
                    <select
                      id='interval'
                      className='js-example-templating js-persons form-control'>
                      <option
                        value='86400'
                        title='60 sec * 60 minutes * 24 hours = 86400 sec = 1 day'>
                        Last day
                      </option>
                      <option
                        value='604800'
                        title='86400 sec * 7 days = 604800 sec = 1 week'>
                        Last week
                      </option>
                      <option
                        value='2592000'
                        title='86400 sec * 30 days = 2592000 sec = 1 month'>
                        Last month
                      </option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div className='row'>
              <div className='btn-list'>
                <input
                  className='btn btn-info'
                  id='exec_btn'
                  type='button'
                  value='Execute report'
                />
              </div>
            </div>
            <div id='log'></div>
            {/* <div className={`${styles.tableBody}`}>
              <table
                id='dtHorizontalVerticalExample'
                className={`${styles.dtHorizontalVerticalExample} table table-striped table-bordered`}
                cellspacing='0'>
                <thead className='sticky-top'>
                  <tr>
                    <th>Driver Name</th>
                    <th>Driver Score</th>
                    <th>Distance</th>
                    <th>Max Speed</th>
                    <th className='table table-striped table-bordered'>
                      <thead>Harsh Events</thead>
                      <td>Acceleration</td>
                      <td>Braking</td>
                      <td>Driving Hours</td>
                      <td>Speed</td>
                    </th>
                    <th>Driver Score Components</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Tiger</td>
                    <td>Nixon</td>
                    <td>System Architect</td>
                    <td>Edinburgh</td>
                    <td>
                      <td>43</td>
                      <td>43</td>
                      <td>43</td>
                      <td>43</td>
                    </td>
                    <td>2011/04/25</td>
                    <td>$320,800</td>
                    <td>5421</td>
                    <td>t.nixon@datatables.net</td>
                  </tr>
                  <tr>
                    <td>Garrett</td>
                    <td>Winters</td>
                    <td>Accountant</td>
                    <td>Tokyo</td>
                    <td>63</td>
                    <td>2011/07/25</td>
                    <td>$170,750</td>
                    <td>8422</td>
                    <td>g.winters@datatables.net</td>
                  </tr>
                  <tr>
                    <td>Ashton</td>
                    <td>Cox</td>
                    <td>Junior Technical Author</td>
                    <td>San Francisco</td>
                    <td>66</td>
                    <td>2009/01/12</td>
                    <td>$86,000</td>
                    <td>1562</td>
                    <td>a.cox@datatables.net</td>
                  </tr>
                  <tr>
                    <td>Cedric</td>
                    <td>Kelly</td>
                    <td>Senior Javascript Developer</td>
                    <td>Edinburgh</td>
                    <td>22</td>
                    <td>2012/03/29</td>
                    <td>$433,060</td>
                    <td>6224</td>
                    <td>c.kelly@datatables.net</td>
                  </tr>
                  <tr>
                    <td>Airi</td>
                    <td>Satou</td>
                    <td>Accountant</td>
                    <td>Tokyo</td>
                    <td>33</td>
                    <td>2008/11/28</td>
                    <td>$162,700</td>
                    <td>5407</td>
                    <td>a.satou@datatables.net</td>
                  </tr>
                  <tr>
                    <td>Brielle</td>
                    <td>Williamson</td>
                    <td>Integration Specialist</td>
                    <td>New York</td>
                    <td>61</td>
                    <td>2012/12/02</td>
                    <td>$372,000</td>
                    <td>4804</td>
                    <td>b.williamson@datatables.net</td>
                  </tr>
                </tbody>
              </table>
            </div> */}
          </div>
        </div>
      </main>
    </>
  );
}
